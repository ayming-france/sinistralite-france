---
phase: 04-export-csv
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.html, js/insights.js, js/app.js]
autonomous: true
requirements: [EXPORT-01, EXPORT-02]

must_haves:
  truths:
    - "Un bouton Télécharger CSV est visible dans le Share drawer pour chaque vue (AT, MP, Trajet)"
    - "Le bouton CSV est désactivé quand aucun secteur n'est sélectionné"
    - "Le clic sur le bouton CSV télécharge un fichier .csv contenant le code NAF, le nom du secteur et toutes les valeurs KPI"
    - "Le fichier CSV s'ouvre dans Excel avec les accents français préservés"
    - "Le nom du fichier suit le format sinistralite-{vue}-{code-NAF}.csv"
  artifacts:
    - path: "index.html"
      provides: "CSV download button in Share drawer"
      contains: "downloadCSVBtn"
    - path: "js/insights.js"
      provides: "downloadCSV function with Blob + BOM"
      exports: ["downloadCSV"]
    - path: "js/app.js"
      provides: "CSV button click listener and disabled state management"
      contains: "downloadCSV"
  key_links:
    - from: "js/app.js"
      to: "js/insights.js"
      via: "import downloadCSV"
      pattern: "downloadCSV"
    - from: "js/app.js"
      to: "js/state.js"
      via: "state.activeView and state.views[viewId].code for disabled state"
      pattern: "state\\.views.*code"
    - from: "js/insights.js"
      to: "js/data.js"
      via: "getData and getStore for KPI values"
      pattern: "getData|getStore"
---

<objective>
Remplacer le bouton PDF cassé du Share drawer par un bouton CSV fonctionnel qui télécharge les données KPI du secteur actuellement affiché.

Purpose: Permettre aux utilisateurs d'exporter les données du dashboard pour analyse externe (Excel, tableur).
Output: Bouton CSV dans le Share drawer, fonction downloadCSV dans insights.js, listener et disabled state dans app.js.
</objective>

<execution_context>
@/Users/encarv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/encarv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-export-csv/04-RESEARCH.md
@index.html
@js/insights.js
@js/app.js
@js/data.js
@js/state.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace PDF button with CSV button and implement downloadCSV function</name>
  <files>index.html, js/insights.js</files>
  <action>
In index.html:
- Find the `#downloadPDFBtn` button inside the `#shareDrawer`.
- Replace it with a new button: `id="downloadCSVBtn"`, label "Télécharger CSV", with a download SVG icon (use a simple arrow-down icon inline SVG or Unicode ↓). Keep the same position (below the link-sharing option).
- Add `disabled` attribute by default and `aria-disabled="true"`.
- Add `aria-label="Télécharger les données du secteur en CSV"`.

In js/insights.js:
- Remove the `downloadPDF` function entirely (it is `window.print()`, broken).
- Add a new exported function `downloadCSV(viewId)` that:
  1. Gets `state.views[viewId]` for the current code and level.
  2. Returns early if `!vs.code` (no sector selected).
  3. Gets the data entry via `getData(viewId)` then finds the entry for `vs.code` in `getStore(viewId, vs.level)`.
  4. Reads `VIEW_CONFIG[viewId]` from kpi.js (already imported) for `eventLabel` and `eventKey`.
  5. Builds CSV with UTF-8 BOM (`'\uFEFF'`), semicolon separator.
  6. Headers (French): `Code NAF;Secteur;Indice de fréquence;Taux de gravité;{cfg.eventLabel};Incapacités permanentes;Décès;Jours perdus;Salariés`
  7. Data row: quote the libelle field (escape internal quotes with `""`), use `!= null` guards on optional numeric fields (especially `taux_gravite` which may be absent in Trajet), default to empty string if null.
  8. Creates Blob with `type: 'text/csv;charset=utf-8;'`.
  9. Uses `URL.createObjectURL` + synthetic anchor with `download` attribute.
  10. Filename: `sinistralite-{viewCode}-{code}.csv` where viewCode mapping is `{ at: 'AT', mp: 'MP', trajet: 'Trajet' }`.
  11. Clicks anchor, then `URL.revokeObjectURL`.
- Update the module exports: replace `downloadPDF` with `downloadCSV` in the export statement.

IMPORTANT: Check the actual stats field names in the JSON data files before building the row. Inspect `data/at-data.json`, `data/mp-data.json`, and `data/trajet-data.json` to confirm which fields exist per view. Use empty string fallback for any missing field.

IMPORTANT: The `VIEW_CONFIG` object and its `eventLabel`/`eventKey` properties must be verified from `js/kpi.js`. If `eventLabel` is not available at import time in insights.js, hardcode the label mapping: `{ at: 'AT 1er règlement', mp: 'MP 1er règlement', trajet: 'Trajets' }`.
  </action>
  <verify>
    <automated>grep -q 'downloadCSVBtn' index.html && grep -q 'downloadCSV' js/insights.js && grep -q 'uFEFF' js/insights.js && echo "PASS" || echo "FAIL"</automated>
    <manual>Open index.html in browser, open Share drawer, verify CSV button appears disabled.</manual>
  </verify>
  <done>
- Le bouton #downloadPDFBtn est remplacé par #downloadCSVBtn dans le Share drawer
- La fonction downloadCSV existe dans insights.js avec BOM UTF-8, séparateur point-virgule, et guards null
- Le nom de fichier suit le format sinistralite-{vue}-{code}.csv
- La fonction downloadPDF est supprimée
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire CSV button listener and disabled state management</name>
  <files>js/app.js</files>
  <action>
In js/app.js:
- Update the import from insights.js: replace `downloadPDF` with `downloadCSV`.
- In `attachDrawerListeners()` (or wherever `downloadPDFBtn` is referenced):
  - Replace the `#downloadPDFBtn` click listener with `#downloadCSVBtn`.
  - The click handler calls `downloadCSV(state.activeView)`.
- Add disabled state management for the CSV button:
  1. In the `render()` function (or wherever KPI cards are updated after sector selection): set `downloadCSVBtn.disabled` and `aria-disabled` based on whether `state.views[state.activeView].code` is truthy.
  2. Also update the disabled state when the view switches (in `switchView()` or at drawer open time), because the Share drawer is shared across views. When user switches from AT (sector selected) to MP (no sector), the button must become disabled.
  3. Use `el('downloadCSVBtn')` to get the element (following existing codebase pattern with the `el()` helper).

Per user decision: download is silent (no toast, no notification). The browser handles the download natively.
  </action>
  <verify>
    <automated>grep -q 'downloadCSV' js/app.js && grep -q 'downloadCSVBtn' js/app.js && ! grep -q 'downloadPDF' js/app.js && echo "PASS" || echo "FAIL"</automated>
    <manual>Open dashboard, select a sector in AT view, open Share drawer, click CSV button. Verify file downloads with correct name and content. Switch to MP view without selecting a sector, verify button is disabled.</manual>
  </verify>
  <done>
- Le listener du bouton CSV appelle downloadCSV(state.activeView) au clic
- Le bouton est désactivé quand aucun secteur n'est sélectionné dans la vue active
- Le disabled state se met à jour au changement de vue (Share drawer partagé)
- Aucune référence à downloadPDF ne reste dans app.js
  </done>
</task>

</tasks>

<verification>
1. Ouvrir le dashboard, sélectionner un secteur en vue AT
2. Ouvrir le Share drawer : le bouton "Télécharger CSV" est actif
3. Cliquer : un fichier sinistralite-AT-{code}.csv se télécharge
4. Ouvrir le CSV dans Excel : accents corrects, colonnes séparées par point-virgule
5. Le fichier contient une ligne d'en-têtes et une ligne de données avec Code NAF, Secteur, et toutes les KPI
6. Basculer en vue MP sans sélectionner de secteur : le bouton CSV est grisé/désactivé
7. Sélectionner un secteur en MP : le bouton redevient actif, le CSV téléchargé a le bon contenu MP
8. Répéter pour la vue Trajet
</verification>

<success_criteria>
- Le bouton PDF cassé est entièrement remplacé par un bouton CSV fonctionnel
- Les 3 vues (AT, MP, Trajet) produisent chacune un CSV correct
- Le CSV s'ouvre dans Excel avec accents français préservés (BOM UTF-8)
- Le bouton est désactivé sans secteur sélectionné, actif avec un secteur
- Le nom de fichier respecte le format sinistralite-{vue}-{code}.csv
</success_criteria>

<output>
After completion, create `.planning/phases/04-export-csv/04-01-SUMMARY.md`
</output>
