---
phase: 01-branding-et-robustesse
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - js/data.js
  - js/app.js
  - index.html
  - styles/base.css
  - styles/charts.css
  - styles/dark.css
autonomous: false
requirements:
  - ROBUST-01
  - ROBUST-02
  - ROBUST-03
  - ROBUST-04
  - ROBUST-05

must_haves:
  truths:
    - "L'utilisateur voit des skeletons animés (pulse/shimmer) pendant le chargement des données"
    - "Chaque section (KPI, charts) a son propre skeleton qui disparaît quand la section charge"
    - "Les skeletons s'adaptent au thème dark/light actif"
    - "Si le fetch échoue, un message d'erreur clair s'affiche avec un bouton Réessayer"
    - "Cliquer sur Réessayer relance le chargement des données"
    - "Aucune classe CSS morte ne subsiste dans les feuilles de style"
  artifacts:
    - path: "js/data.js"
      provides: "Error handling on fetch with response.ok check"
      contains: "response.ok"
    - path: "js/app.js"
      provides: "Loading state management, skeleton show/hide, error UI"
      contains: "skeleton"
    - path: "index.html"
      provides: "Skeleton HTML placeholders and error state container"
      contains: "skeleton"
    - path: "styles/base.css"
      provides: "Skeleton CSS with pulse animation, error state styles, no dead CSS"
      contains: "@keyframes shimmer"
  key_links:
    - from: "js/data.js"
      to: "js/app.js"
      via: "loadDataset throws on fetch failure, caught by Promise.all wrapper"
      pattern: "throw.*Error|catch"
    - from: "js/app.js"
      to: "index.html"
      via: "skeleton elements shown/hidden by class toggle"
      pattern: "skeleton"
    - from: "styles/base.css"
      to: "index.html"
      via: "skeleton CSS animates placeholder elements"
      pattern: "shimmer|skeleton"
---

<objective>
Add loading skeletons, error handling with retry, and clean up dead CSS. The dashboard must give visual feedback during data loading and gracefully handle failures.

Purpose: Users currently see a blank screen while 9.2 MB of JSON loads. Failed fetches crash silently. Dead CSS adds noise.
Output: Skeleton loaders, error state with retry button, cleaned CSS files.
</objective>

<execution_context>
@/Users/encarv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/encarv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-branding-et-robustesse/01-CONTEXT.md
@.planning/phases/01-branding-et-robustesse/01-01-SUMMARY.md
@.planning/codebase/QUALITY.md
@.planning/codebase/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add skeleton loaders and error handling to data loading flow</name>
  <files>js/data.js, js/app.js, index.html, styles/base.css</files>
  <action>
**1. Update `js/data.js` to handle fetch errors:**

Add `response.ok` check and meaningful error in `loadDataset()`:

```js
export async function loadDataset(type) {
  if (DATASETS[type]) return DATASETS[type];
  var resp = await fetch('./data/' + type + '-data.json');
  if (!resp.ok) throw new Error('Échec du chargement des données ' + type + ' (' + resp.status + ')');
  var json = await resp.json();
  DATASETS[type] = json;
  return json;
}
```

**2. Add skeleton HTML in `index.html`:**

Before the `.container` div (after `</nav>` for nav-rail), add a loading skeleton section that displays by default and gets hidden after data loads:

```html
<div class="loading-skeleton" id="loadingSkeleton">
  <div class="skeleton-header">
    <div class="skeleton-line skeleton-title"></div>
    <div class="skeleton-line skeleton-subtitle"></div>
  </div>
  <div class="skeleton-kpi-grid">
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
  </div>
  <div class="skeleton-charts">
    <div class="skeleton-chart-card"></div>
    <div class="skeleton-chart-card"></div>
  </div>
</div>
```

Also add an error state container (hidden by default):

```html
<div class="error-state" id="errorState" style="display:none">
  <div class="error-content">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    <h2>Erreur de chargement</h2>
    <p id="errorMessage">Impossible de charger les données.</p>
    <button class="retry-btn" id="retryBtn">Réessayer</button>
  </div>
</div>
```

The skeleton should be placed INSIDE `.container` at the top, so it respects the same layout (margin-left for nav rail). The `.container` content (header, views) should initially be hidden via a `.loading` class on the container.

**3. Add skeleton CSS in `styles/base.css`:**

Add at the end of the file (before the `@media print` block):

- `.loading-skeleton`: padding matching container, visible by default
- `.skeleton-line`: height 1rem, width 60%, background `var(--bg-elevated)`, border-radius 4px
- `.skeleton-title`: height 1.5rem, width 40%
- `.skeleton-subtitle`: height 1rem, width 60%, margin-top 8px
- `.skeleton-kpi-grid`: display grid, 3 columns (matching `.kpi-grid`), gap 16px, margin-top 24px
- `.skeleton-card`: height 100px, background `var(--bg-elevated)`, border-radius 12px
- `.skeleton-charts`: display grid, 2 columns, gap 16px, margin-top 24px
- `.skeleton-chart-card`: height 200px, background `var(--bg-elevated)`, border-radius 12px
- Shimmer animation: `@keyframes shimmer` that moves a gradient highlight from left to right. Apply via `background: linear-gradient(90deg, var(--bg-elevated) 25%, var(--bg-card) 50%, var(--bg-elevated) 75%)` with `background-size: 200% 100%` and `animation: shimmer 1.5s infinite`.
- `.error-state`: centered flex container, text-align center, padding 80px 24px
- `.error-content h2`: margin-top 16px, color `var(--text)`
- `.error-content p`: color `var(--text-secondary)`, margin 8px 0 24px
- `.retry-btn`: background `var(--accent)`, color white, border none, padding 10px 24px, border-radius 8px, cursor pointer, font-size 1rem

The skeleton colors automatically adapt to dark/light theme because they use CSS custom properties.

Per user decision: "Skeleton colors adapt to current dark/light theme" and "Pulse/shimmer animation on skeleton shapes".

**4. Update `js/app.js` DOMContentLoaded handler:**

Wrap the `Promise.all` in a try/catch:

```js
document.addEventListener('DOMContentLoaded', async function() {
  try {
    await Promise.all([
      loadDataset('at'),
      loadDataset('mp'),
      loadDataset('trajet'),
    ]);

    // Hide skeleton, show content
    var skeleton = document.getElementById('loadingSkeleton');
    if (skeleton) skeleton.style.display = 'none';

    // ... rest of existing init code unchanged ...

  } catch (err) {
    // Hide skeleton
    var skel = document.getElementById('loadingSkeleton');
    if (skel) skel.style.display = 'none';

    // Show error state
    var errorState = document.getElementById('errorState');
    var errorMsg = document.getElementById('errorMessage');
    if (errorState) errorState.style.display = 'flex';
    if (errorMsg) errorMsg.textContent = err.message || 'Impossible de charger les données.';

    // Retry button reloads the page
    var retryBtn = document.getElementById('retryBtn');
    if (retryBtn) retryBtn.addEventListener('click', function() {
      window.location.reload();
    });
  }
});
```

The `.container` should be hidden initially (add `style="display:none"` to the `.container` div in HTML) and shown after successful load. Or better: the skeleton is shown inside container, and after load the skeleton is hidden and views become visible. Choose the approach that minimizes layout shift.

Simplest: show skeleton inside container, hide it after load. The header and views are already there but empty (no data rendered yet), so they won't show content until render() is called.
  </action>
  <verify>
    <automated>cd /Users/encarv/.claude/datagouv && grep -c "shimmer" styles/base.css && grep -c "loadingSkeleton" index.html && grep -c "errorState" index.html && grep -c "resp.ok\|response.ok" js/data.js</automated>
    <manual>1. Open dashboard with DevTools Network tab, throttle to Slow 3G, verify skeletons appear with shimmer animation. 2. Block data/*.json requests in DevTools, reload, verify error message + retry button appear. 3. Toggle dark mode before load to verify skeleton colors adapt.</manual>
  </verify>
  <done>Skeleton loaders visible during data fetch with shimmer animation. Error state with French message and retry button shown on fetch failure. Skeletons adapt to dark/light theme.</done>
</task>

<task type="auto">
  <name>Task 2: Remove dead CSS classes and unused file</name>
  <files>styles/base.css, styles/charts.css, styles/dark.css, index.html</files>
  <action>
**1. In `styles/base.css`, remove these unused CSS rules** (identified in QUALITY.md):

- `.empty-lead` (around line 163)
- `.naf-table` (around line 172)
- `.naf-row` (around line 178)
- `.naf-badge` (around line 190)
- `.naf-desc` (around line 197)
- `.naf-example` (around line 201)
- `.naf-label` (around line 208)
- `--serif` CSS variable declaration in `:root` (around line 24)

Before removing, do a final grep to confirm none are used in any HTML or JS file.

**2. In `styles/charts.css`, remove these unused CSS rules:**

- `.evo-delta`, `.evo-delta.up`, `.evo-delta.down`, `.evo-delta.neutral` (around lines 306-317)
- `.funnel-tooltip .tt-pct` (around line 272)

Before removing, grep to confirm none are used.

**3. Handle `styles/dark.css`:**

This file is empty (just a comment placeholder). Remove the `<link rel="stylesheet" href="styles/dark.css">` tag from `index.html` (around line 19). Keep the `dark.css` file itself (it may be useful later per its comment), but stop loading it since it adds a network request for nothing.

**4. Verify no references broke:**

After removing, grep the entire project for each removed class name to confirm no orphaned references.
  </action>
  <verify>
    <automated>cd /Users/encarv/.claude/datagouv && for cls in empty-lead naf-table naf-row naf-badge naf-desc naf-example naf-label evo-delta tt-pct; do echo -n "$cls: "; grep -rn "$cls" styles/ js/ index.html 2>/dev/null | wc -l; done</automated>
    <manual>Open dashboard, verify no visual regressions (all sections render correctly)</manual>
  </verify>
  <done>Dead CSS classes removed from base.css and charts.css. dark.css no longer loaded in index.html. Zero references to removed classes remain in the codebase.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of all Phase 1 changes</name>
  <files>index.html, landing.html</files>
  <action>
No automated changes. This is a human verification checkpoint for all Phase 1 work (Plans 01 and 02).

What was built:
- Plan 01 (branding): French accents in KPI labels, chart bar SVG favicon, nav logo with chart icon, Lato font in charts, shared theme key.
- Plan 02 (robustness): Skeleton loaders with shimmer animation during data load, error state with retry button on fetch failure, dead CSS removed.
  </action>
  <verify>
    1. Open http://localhost:5501/ (or Live Server URL)
    2. Check browser tab: should show chart bar icon favicon + "Sinistralité France" title
    3. Check nav bar top-left: should show chart icon + "Sinistralité France" text
    4. Open DevTools > Network, throttle to "Slow 3G", reload: verify skeleton loaders with shimmer appear
    5. After data loads, select a sector (e.g., search "01"): verify KPI labels show "Décès", "Journées perdues", "Incapacités permanentes", "Salariés" with correct accents
    6. Check chart fonts look like Lato (same as body text)
    7. Open DevTools > Network, block requests to data/*.json, reload: verify error message "Erreur de chargement" appears with a "Réessayer" button
    8. Unblock requests, click "Réessayer": verify page reloads and data loads
    9. Toggle dark mode, verify skeletons (if visible) adapt to dark theme colors
    10. Open landing.html: verify same favicon in tab, toggle theme, go back to dashboard, verify theme is preserved
  </verify>
  <done>User confirms all visual and functional aspects of Phase 1 are correct. Type "approved" or describe issues.</done>
</task>

</tasks>

<verification>
1. `grep -rn "DM Sans" js/` returns 0 matches (from Plan 01)
2. Skeleton HTML present in index.html
3. Shimmer animation defined in base.css
4. Error state with retry button in index.html
5. `loadDataset()` has response.ok check
6. Dead CSS classes (empty-lead, naf-table, naf-row, naf-badge, naf-desc, naf-example, naf-label, evo-delta, tt-pct) return 0 grep matches
7. dark.css not loaded in index.html
8. Visual verification by user (checkpoint)
</verification>

<success_criteria>
- Skeleton loaders with shimmer animation visible during data load
- Error message with retry button displayed on fetch failure
- Dead CSS removed (zero orphaned references)
- dark.css not loaded (one fewer network request)
- User visually confirms all Phase 1 changes look correct
</success_criteria>

<output>
After completion, create `.planning/phases/01-branding-et-robustesse/01-02-SUMMARY.md`
</output>
