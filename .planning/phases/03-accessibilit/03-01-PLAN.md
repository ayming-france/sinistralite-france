---
phase: 03-accessibilit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - styles/base.css
  - js/insights.js
  - js/app.js
autonomous: true
requirements:
  - A11Y-01
  - A11Y-02
  - A11Y-03

must_haves:
  truths:
    - "Un utilisateur clavier peut tab vers un lien 'Aller au contenu principal' comme premier élément focusable de la page"
    - "Chaque bouton, input et lien interactif a un aria-label descriptif en français"
    - "Un screen reader annonce l'ouverture et la fermeture des drawers Insights et Share via aria-expanded"
    - "Le focus est piégé dans un drawer ouvert et revient au bouton déclencheur à la fermeture"
    - "Les outlines clavier sont visibles via :focus-visible sans apparaître au clic"
  artifacts:
    - path: "index.html"
      provides: "Skip link, aria-labels, aria-expanded, role=dialog sur drawers, id=main-content"
      contains: "skip-link"
    - path: "styles/base.css"
      provides: "CSS skip-link + :focus-visible global"
      contains: "focus-visible"
    - path: "js/insights.js"
      provides: "trapFocus, releaseFocus, focus management dans toggleInsights/toggleShare, aria-expanded sync dans setAllBtns"
      contains: "trapFocus"
    - path: "js/app.js"
      provides: "Escape handler synchronise releaseFocus pour les drawers"
      contains: "releaseFocus"
  key_links:
    - from: "index.html"
      to: "styles/base.css"
      via: ".skip-link class and :focus-visible rules"
      pattern: "skip-link"
    - from: "js/insights.js"
      to: "index.html"
      via: "aria-expanded attribute sync on drawer trigger buttons"
      pattern: "aria-expanded"
    - from: "js/app.js"
      to: "js/insights.js"
      via: "Escape key handler calls releaseFocus and returns focus to trigger"
      pattern: "releaseFocus"
---

<objective>
Rendre le dashboard utilisable par les lecteurs d'écran et la navigation clavier en ajoutant les ARIA labels, le skip link, la gestion du focus des drawers, et les indicateurs :focus-visible.

Purpose: Les utilisateurs de technologies d'assistance peuvent naviguer et interagir avec toutes les fonctionnalités du dashboard.
Output: index.html avec markup ARIA complet, base.css avec skip-link et focus-visible, insights.js avec focus trap et aria-expanded, app.js avec Escape handler mis à jour.
</objective>

<execution_context>
@/Users/encarv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/encarv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-accessibilit/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add skip link, aria-labels, drawer role attributes, and :focus-visible CSS</name>
  <files>index.html, styles/base.css</files>
  <action>
**In index.html:**

1. **Skip link (A11Y-03):** Insert as first child of `<body>`, before the top-nav:
   ```html
   <a href="#main-content" class="skip-link">Aller au contenu principal</a>
   ```

2. **Main content target (A11Y-03):** Add `id="main-content"` and `tabindex="-1"` to the `.container` div so programmatic focus works across all browsers.

3. **Static aria-labels (A11Y-01):** Add `aria-label` attributes to all interactive elements listed in 03-RESEARCH.md "Inventaire exhaustif" table. Key items:
   - `.top-nav-logo`: `aria-label="Retourner à l'accueil Sinistralité France"`
   - Nav rail buttons (4): "Accidents du Travail", "Maladies Professionnelles", "Accidents de Trajet", "Vue d'ensemble (bientôt disponible)"
   - Search inputs (3): `aria-label="Rechercher un secteur par code NAF ou mot-clé"`
   - Insights buttons (3): `aria-label="Afficher les insights"`
   - Share buttons (3): `aria-label="Partager"`
   - Close buttons: `aria-label="Fermer les insights"`, `aria-label="Fermer le partage"`
   - NAF level buttons (9, 3 per view): "Niveau NAF 2", "Niveau NAF 4", "Niveau NAF 5 (complet)"
   - Comp toggle buttons (6, 2 per view): "Afficher en graphique", "Afficher en tableau"

4. **aria-expanded on drawer triggers (A11Y-02):** Add `aria-expanded="false"` to all 6 drawer trigger buttons (insightsBtn, mp-insightsBtn, trajet-insightsBtn, shareBtn, mp-shareBtn, trajet-shareBtn).

5. **Drawer role attributes (A11Y-02):** Add `role="dialog"` and `aria-modal="true"` to:
   - `#insightsDrawer`: also add `aria-label="Insights"`
   - `#shareDrawer`: also add `aria-label="Partager"`

6. **aria-live on drawer body (A11Y-02):** Add `aria-live="polite"` to `#drawerBody` (insights drawer body) so screen readers announce content changes.

**Do NOT add aria-label to elements that already have visible text content (retry button, copy link button, download PDF button). Do NOT touch elements already labelled (themeToggle, bottom nav buttons).**

**In styles/base.css:**

7. **Skip link CSS (A11Y-03):** Add at the end of the file:
   ```css
   .skip-link {
     position: absolute;
     top: -100%;
     left: 0;
     padding: 0.5rem 1rem;
     background: var(--accent, #4e8ac5);
     color: #fff;
     font-weight: 700;
     font-size: 0.875rem;
     z-index: 9999;
     border-radius: 0 0 4px 0;
     text-decoration: none;
     transition: top 0.1s;
   }
   .skip-link:focus {
     top: 0;
   }
   ```

8. **:focus-visible CSS (A11Y-01):** Add global focus indicator rules:
   ```css
   :focus-visible {
     outline: 2px solid var(--accent);
     outline-offset: 2px;
     border-radius: 2px;
   }
   :focus:not(:focus-visible) {
     outline: none;
   }
   ```
  </action>
  <verify>
    <automated>grep -c "skip-link" index.html && grep -c "aria-label" index.html && grep -c "focus-visible" styles/base.css && grep -c "role=\"dialog\"" index.html</automated>
    <manual>Tab through the page with keyboard. First Tab press should reveal the "Aller au contenu principal" skip link. All buttons should show visible focus outline on keyboard focus but not on mouse click.</manual>
  </verify>
  <done>Skip link is present as first focusable element, all interactive elements have descriptive French aria-labels, drawers have role=dialog + aria-modal, drawer triggers have aria-expanded="false", :focus-visible outline is applied globally, no outline appears on mouse click.</done>
</task>

<task type="auto">
  <name>Task 2: Implement drawer focus trap, aria-expanded sync, and Escape handler update</name>
  <files>js/insights.js, js/app.js</files>
  <action>
**In js/insights.js:**

1. **Add focusable selector constant** at module scope:
   ```js
   var FOCUSABLE = 'button:not([disabled]), [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
   ```

2. **Add trapFocus helper** that listens for Tab/Shift+Tab and cycles focus within the drawer:
   - Get all focusable elements inside the drawer
   - On Tab at last element, wrap to first; on Shift+Tab at first, wrap to last
   - Store handler reference on `drawer._trapHandler` for cleanup

3. **Add releaseFocus helper** that removes the keydown listener stored in `drawer._trapHandler`.

4. **Export releaseFocus** (needed by app.js for Escape handler).

5. **Modify setAllBtns** to synchronize `aria-expanded`: when toggling the class, also set `aria-expanded` to `'true'` or `'false'` matching the `val` parameter. This ensures the 3 prefixed buttons (at, mp, trajet) all stay in sync.

6. **Modify toggleInsights:**
   - After the `classList.toggle('open')` call, check `isOpen`:
     - If open: call `trapFocus(drawer)`, then `drawer.querySelector('.close-btn').focus()`
     - If closed: call `releaseFocus(drawer)`, compute the active view prefix (`state.activeView === 'at' ? '' : state.activeView + '-'`), find the trigger button via `el(prefix + 'insightsBtn')`, call `.focus()` on it
   - Also close the share drawer's focus trap if share drawer was open (existing logic already closes it, just add `releaseFocus(shareDrawer)` before).

7. **Modify toggleShare:** Same pattern as toggleInsights but for the share drawer:
   - On open: `trapFocus(drawer)`, focus the close button
   - On close: `releaseFocus(drawer)`, return focus to `el(prefix + 'shareBtn')`
   - Also release insights drawer focus trap if it was open.

**In js/app.js:**

8. **Import releaseFocus** from `./insights.js`.

9. **Update Escape key handler** (around line 199-200): when Escape closes a drawer, also call `releaseFocus(drawer)` and return focus to the appropriate trigger button. The existing handler calls `toggleInsights()`/`toggleShare()` which already handles this via steps 6-7 above. Verify no duplicate releaseFocus call. If the Escape handler closes drawers by directly removing `.open` class (bypassing toggle functions), refactor it to call the toggle functions instead so ARIA state stays in sync.

**Anti-patterns to avoid:**
- Do NOT add a separate Escape listener in the focus trap (the existing app.js handler already covers it)
- Do NOT add `tabindex` to the drawer div itself (focus goes to `.close-btn` which is a real button)
- Do NOT clear and refill `drawerBody.innerHTML` in two separate operations with a timeout (breaks aria-live announcements)
  </action>
  <verify>
    <automated>grep -c "trapFocus" js/insights.js && grep -c "releaseFocus" js/insights.js && grep -c "aria-expanded" js/insights.js && grep -c "FOCUSABLE" js/insights.js</automated>
    <manual>Open the Insights drawer, verify Tab cycles between focusable elements without escaping. Press Escape, verify focus returns to the Insights trigger button. Open Share drawer, same test. Verify screen reader announces drawer content via aria-live.</manual>
  </verify>
  <done>Focus is trapped inside open drawers (Tab cycles, Shift+Tab reverse cycles). Escape closes drawer and returns focus to trigger button. aria-expanded toggles on all 6 drawer trigger buttons. releaseFocus is called on every close path (toggle, Escape, click outside).</done>
</task>

</tasks>

<verification>
1. **Keyboard navigation test:** Tab from page load. First focus = skip link. Activating skip link moves focus to main content. Continue tabbing through all interactive elements (nav rail, search inputs, level tabs, comp toggles, action buttons). Each shows :focus-visible outline (2px solid accent color).
2. **Screen reader simulation:** aria-labels read correctly on all interactive elements (check with browser accessibility inspector or axe DevTools). Drawer triggers announce "Afficher les insights, collapsed" and "Afficher les insights, expanded" when toggled.
3. **Focus management test:** Open Insights drawer, Tab cycles within drawer only. Shift+Tab cycles backward. Escape returns focus to trigger. Same for Share drawer. Click outside drawer also returns focus and releases trap.
4. **Theme compatibility:** Focus outline uses `var(--accent)` so it adapts to light and dark themes. Skip link uses same accent color.
5. **No regressions:** All existing click handlers, autocomplete, chart interactions, hash routing continue to work. Bottom nav mobile still functional.
</verification>

<success_criteria>
- Skip link visible on first Tab press, navigates to main content
- All interactive elements have French aria-labels (verified via DOM inspection: at least 30 aria-label attributes in index.html)
- Drawer open/close announced via aria-expanded toggle on trigger buttons
- Focus trapped inside open drawers, released on close with focus return to trigger
- :focus-visible outline appears on keyboard focus, not on mouse click
- No accessibility errors in browser dev tools accessibility panel for interactive elements
</success_criteria>

<output>
After completion, create `.planning/phases/03-accessibilit/03-01-SUMMARY.md`
</output>
